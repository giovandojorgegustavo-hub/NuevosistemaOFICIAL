 CL40: Consola Paquetes


Índice
Consola Paquetes	2
## Caso de Uso: Narrativa:	2
## Precondiciones	2
## Comportamiento	3
## Stack técnico:**	3
## Estructura del código:	3
## User Experience (UX)	3
## Reglas de Implementación Críticas	3
## Entregables:	4
## Funciones	5
liquidarpaquete()	5
procesarStandBy()	5
Anexo I. Scripts MySQL	7
get_tablero	9
get_column_pktes	9
get_column_pktes	9
get_productos_pkte	10
get_hr_apertura	10
get_turno	11
get_usecase_link	11
erp.yml	11
Anexo II. Style	13


Consola Paquetes
## Caso de Uso: Narrativa:
Quiero hacer una página WEB que sirva para gestionar paquetes en diferentes estados. Vamos a mostrar los paquetes en diferentes columnas según su estado.

El SP get_tablero(“PAQ”) devuelve la lista de columnas disponibles donde se podrán clasificar los paquetes que son devueltos por el SP get_paquetes(NOW(), vUsuario) para el día de hoy.

Las columnas devueltas por get_tablero() estarán ordenadas de acuerdo al campo ordinal, y deben mostrar el contenido del campo título..

Cada paquete debe ser mostrado como una Card en la columna ordinal del tablero.
La Card en la lista debe mostrar los campos;
- nombre_cliente
- concatenarpuntoentrega
- fecha_registro

Los datos de conexión a MySQL se deben tomar del archivo `erp.yml`; la variable `{dsn}` tiene los datos de conexión y se debe usar la DB especificada en la variable `{name}`.

El backend debe iniciar en el puerto configurado en el archivo `erp.yml`m variable “ports.services.consola_paquetes”.
## Precondiciones 
La página debe recibir dos parámetros obligatorios y un tercer parámetro opcional. Los parámetros son:

- `Codigo_usuario` varchar(36)
- `OTP` varchar(6)
- `vParámetros` JSON (opcional)

Al iniciar la página se debe llamar el SP `validar_otp_usuario` pasándole  como parámetros `Codigo_usuario`,  `OTP`  y la variable vUsResultado como parametro de salida del SP con el resultado de la validación del usuario verificar si es un usuario válido.

El SP `validar_otp_usuario` devuelve:
- `1`: SI usuario y OTP son válidos.
- `-1`: OTP expirado.
- `0`: NO EXISTE TOKEN.

Si `validar_otp_usuario` devuelve un valor diferente de `1`:
- Mostrar mensaje exacto: `Warning ACCESO NO AUTORIZADO !!!`
- Cerrar la pagina y salir del programa.

Si `validar_otp_usuario` devuelve `1`:
- El backend debe crear una sesión temporal y retornar `sessionToken`.
- Las llamadas posteriores a endpoints protegidos deben enviar `Authorization: Bearer <sessionToken>`.
- No se debe confiar en `vUsuario` enviado por el cliente para lógica de seguridad.
## Comportamiento
Al dar Doble Click sobre una Card, se debe abrir una ventana modal con los siguientes datos de la tarjeta:

Hora, mostrando el time de la columna get_paquetes.fecha_registro
Cliente, columna get_paquetes.nombre_cliente
Dirección de Entrega. get_paquetes.concatenarpuntoentrega
Un grid llamado vGrid con el detalle de los productos incluidos en el paquete y la cantidad de cada producto, ordenado por el campo ordinal. Para cargar vGrid se debe ejecutar el SP get_productos_pkte(tipo_documento, codigo_paquete).
Si get_paquetes.columna = 1  (EMPACAR)
Mostrar boton “Empacar”. Al dar Click se debe ejecutar la función   Empacar(tipo_documento, codigo_paquete).  Al terminar la función. cerrar la ventana modal y retornar al proceso llamador.
Si get_paquetes.columna = 2  (DESPACHAR)
Mostrar boton “Despachar”. 
Si get_paquetes.columna = 3  (En CAMINO)
Mostrar botón “Liquidar Paquete”.  Al dar Click se debe ejecutar la función   liquidarpaquete().  Al terminar la función. cerrar la ventana modal y retornar al proceso llamador.
Si get_paquetes.columna = 4  (StandBy)
Mostrar botón “Procesar Standby”. Al dar Click se debe ejecutar la función   procesarStandBy().  Al terminar la función. cerrar la ventana modal y retornar al proceso llamador.
Si get_paquetes.columna = 5  (Entregados)
Si get_paquetes.columna = 6  (Otros)

Barra de estado inferior:
- La pantalla debe mostrar una barra fija en la parte inferior.
- La barra debe incluir:
  - Fecha (fecha/hora local actual).
  - Usuario Conectado (vUsuario autenticado).
  - Total de Paquetes (cantidad total de paquetes cargados en el tablero).
- La fecha/hora debe refrescarse en tiempo real.
- El Usuario Conectado y el Total de Paquetes deben actualizarse al cargar/refrescar datos del tablero.
## Stack técnico:** 
HTML5, JavaScript ES6+, Bootstrap 5.3, MySQL, Node.js
## Estructura del código:
- Componentes Bootstrap (alerts, badges, cards, etc.).
- Responsive design para móviles.
- Backend con endpoints JS corriendo sobre Node.js y persistencia en MySQL.

## User Experience (UX)
- Incluir manejo de errores y mejores prácticas de UX.
- Mostrar mensajes de error claros según causa.
- La GUI debe mostrarse en el idioma predeterminado del navegador del usuario.
- La barra de estado inferior también debe respetar el idioma del navegador.
 ## Reglas de Implementación Críticas
Manejo de Errores: Si un SP falla, muestra un toast o alert de Bootstrap detallando el error.
Seguridad: `vUsuario` debe resolverse en backend desde la sesión autenticada (Bearer token), no desde `body/query`.
Seguridad: Endpoints de acción (`empacar/liquidar/standby`) y consulta de productos deben requerir autenticación.
Seguridad: Antes de lanzar un use case, validar que el paquete exista dentro de `get_paquetes(NOW(), vUsuario)` y que esté en la columna esperada para la acción.
Seguridad: Sanitizar `linktolaunch`; permitir solo rutas/URLs válidas de casos de uso y protocolo http/https.
Seguridad Frontend: Escapar datos dinámicos antes de renderizar HTML para evitar XSS.
UX: Las cards deben tener un efecto hover y el cursor debe cambiar a pointer.

## Entregables:
Archivo server.js (Node.js/Express).
Archivo index.html (Estructura base con el CSS integrado).
Archivo app.js (Lógica de fetch y renderizado dinámico).

## Funciones
liquidarpaquete()
Begin
vUseCaseToLaunch = “CU003”

Se deberá Invocar al uses case cargado en vUseCaseToLaunch  pasando 2 parámetros, el Id del Usuario logueado vUsuario y el vOTP.

El vOTP se carga con el resultado del SP “generar_otp_usuario()”  pasandole vUsuario como parámetro.

La variable vLinkToLaunch se debe cargar con el campo linktolaunch que devuelve el SP get_usecase_link(vUseCaseToLaunch).

Cargar la web app de la URL en vLinkToLaunch,  pasando como parametros vUsuario y vOTP respectivamente.
Validar previamente que el paquete solicitado pertenezca al alcance del usuario y esté en columna 3.
End
procesarStandBy()
Begin
vUseCaseToLaunch = “CU004”

Se deberá Invocar al uses case cargado en vUseCaseToLaunch  pasando 2 parámetros, el Id del Usuario logueado vUsuario y el vOTP.

## provisorio durante desarrollo

El vOTP se carga con el resultado del SP “generar_otp_usuario()”  pasandole vUsuario como parámetro.

La variable vLinkToLaunch se debe cargar con el campo linktolaunch que devuelve el SP get_usecase_link(vUseCaseToLaunch).

Cargar la web app de la URL en vLinkToLaunch,  pasando como parametros vUsuario y vOTP respectivamente.
Validar previamente que el paquete solicitado pertenezca al alcance del usuario y esté en columna 4.
End
Empacar(ptipo_documento, pcodigo_paquete)
Begin
vUseCaseToLaunch = “CU2002”

Se deberá Invocar al uses case cargado en vUseCaseToLaunch  pasando 2 parámetros, el Id del Usuario logueado vUsuario y el vOTP.

El vOTP se carga con el resultado del SP “generar_otp_usuario()”  pasandole vUsuario como parámetro.

La variable vLinkToLaunch se debe cargar con el campo linktolaunch que devuelve el SP get_usecase_link(vUseCaseToLaunch).

Cargar la web app de la URL en vLinkToLaunch,  pasando como parametros vUsuario, vOTP,  ptipo_documento, pcodigo_paquete respectivamente.
Validar previamente que el paquete solicitado pertenezca al alcance del usuario y esté en columna 1.
End

### Contrato de Respuesta para acciones
- `POST /api/empacar`, `POST /api/liquidar`, `POST /api/standby` deben responder:
  - `ok`
  - `useCase`
  - `vUsuario`
  - `launchUrl` (incluye `vOTP` como query param)
- No exponer `vOTP` como campo independiente en el JSON de respuesta.
Anexo I. Scripts MySQL
get_paquetes

CREATE DEFINER=`root`@`localhost` PROCEDURE `erpdb`.`get_paquetes`(
	IN p_fecha DATETIME,
	IN p_usuario varchar(36)
	)
BEGIN

   DECLARE v_codigo_base DECIMAL(12);
   DECLARE v_priv_bases varchar(36);

   CALL get_priv_usuario_cp(p_usuario, v_codigo_base, v_priv_bases);
    
   IF v_priv_bases = 'ALL' THEN
	   SELECT
	    p.codigo_paquete,
	    p.tipo_documento,
	    p.fecha_actualizado,
	    p.fecha_registro,
	    mc.codigo_cliente,
	    c.nombre AS nombre_cliente,
	    c.numero AS num_cliente,
	    mc.codigo_puntoentrega,
	    mc.codigo_base,
	    get_turno(mc.codigo_base, p.fecha_registro) Turno,
	    b.nombre AS nombre_base,
	    mc.codigo_packing,
	    pk.nombre AS nombre_packing,
	    mc.ordinal_numrecibe,
	    pe.concatenarpuntoentrega,
	    pe.region_entrega,
	    pe.latitud,
	    pe.longitud,
	    nr.concatenarnumrecibe,
	    get_column_pktes(p.estado) columna
	    
	  FROM paquete p
	  LEFT JOIN mov_contable mc
	    ON mc.numero_documento = p.codigo_paquete
	    AND mc.tipo_documento = p.tipo_documento
	  LEFT JOIN clientes c
	    ON c.codigo_cliente = mc.codigo_cliente
	  LEFT JOIN bases b
	    ON b.codigo_base = mc.codigo_base
	  LEFT JOIN packing pk
	    ON pk.codigo_packing = mc.codigo_packing
	  LEFT JOIN numrecibe nr
	    ON nr.codigo_cliente_numrecibe = mc.codigo_cliente_numrecibe
	    AND nr.ordinal_numrecibe = mc.ordinal_numrecibe
	  LEFT JOIN puntos_entrega pe
	    ON pe.codigo_puntoentrega = mc.codigo_puntoentrega
	    AND pe.codigo_cliente_puntoentrega = mc.codigo_cliente_puntoentrega
	WHERE date(p.fecha_registro) = date(p_fecha) 
		or ( date(p.fecha_registro) <> date(p_fecha) and p.estado not in('llegado', 'robado','perdido'))
	--   AND (mc.estado IS NULL OR mc.estado <> 'anulado')
	  ORDER BY p.fecha_registro, p.codigo_paquete ;
   ELSE 
	   SELECT
	    p.codigo_paquete,
	    p.tipo_documento,
	    p.fecha_actualizado,
	    p.fecha_registro,
	    mc.codigo_cliente,
	    c.nombre AS nombre_cliente,
	    c.numero AS num_cliente,
	    mc.codigo_puntoentrega,
	    mc.codigo_base,
	    get_turno(mc.codigo_base, p.fecha_registro) Turno,
	    b.nombre AS nombre_base,
	    mc.codigo_packing,
	    pk.nombre AS nombre_packing,
	    mc.ordinal_numrecibe,
	    pe.concatenarpuntoentrega,
	    pe.region_entrega,
	    pe.latitud,
	    pe.longitud,
	    nr.concatenarnumrecibe,
	    get_column_pktes(p.estado) columna
	    
	  FROM paquete p
	  LEFT JOIN mov_contable mc
	    ON mc.numero_documento = p.codigo_paquete
	    AND mc.tipo_documento = p.tipo_documento
	  LEFT JOIN clientes c
	    ON c.codigo_cliente = mc.codigo_cliente
	  LEFT JOIN bases b
	    ON b.codigo_base = mc.codigo_base
	  LEFT JOIN packing pk
	    ON pk.codigo_packing = mc.codigo_packing
	  LEFT JOIN numrecibe nr
	    ON nr.codigo_cliente_numrecibe = mc.codigo_cliente_numrecibe
	    AND nr.ordinal_numrecibe = mc.ordinal_numrecibe
	  LEFT JOIN puntos_entrega pe
	    ON pe.codigo_puntoentrega = mc.codigo_puntoentrega
	    AND pe.codigo_cliente_puntoentrega = mc.codigo_cliente_puntoentrega
	  WHERE date(p.fecha_registro) = date(p_fecha)
		or ( date(p.fecha_registro) <> date(p_fecha) and p.estado not in('llegado', 'robado','perdido'))
		AND mc.codigo_base = v_codigo_base
	--   AND (mc.estado IS NULL OR mc.estado <> 'anulado')
	  ORDER BY p.fecha_registro, p.codigo_paquete ;   
	END IF;
   
END    
get_tablero

CREATE DEFINER=`adminwb`@`%` PROCEDURE `get_tablero`(
   IN p_tablero VARCHAR(36)
)
BEGIN
    SELECT D.ordinal, D.titulo
    FROM tableros T
    JOIN tableros_detalle D ON T.id = D.id
    WHERE T.id = p_tablero;
END

get_column_pktes

CREATE DEFINER=`adminwb`@`%` FUNCTION `get_column_pktes`(p_estado VARCHAR(30)) RETURNS int
    DETERMINISTIC
BEGIN
    RETURN CASE p_estado
        WHEN 'pendiente empacar' THEN 1
        WHEN 'empacado' THEN 2
        WHEN 'en camino' THEN 3
        WHEN 'standby' THEN 4
        WHEN 'llegado' THEN 5
        WHEN 'robado' THEN 6
        WHEN 'devuelto' THEN 6
        ELSE 0
    END;
END

get_column_pktes

CREATE DEFINER=`root`@`localhost` FUNCTION `get_column_pktes`(p_estado VARCHAR(30)) RETURNS int
    DETERMINISTIC
BEGIN
    RETURN CASE p_estado
        WHEN 'pendiente empacar' THEN 1
        WHEN 'empacado' THEN 2
        WHEN 'en camino' THEN 3
        WHEN 'standby' THEN 4
        WHEN 'llegado' THEN 5
        WHEN 'robado' THEN 6
        WHEN 'devuelto' THEN 6
        ELSE 0
    END;
END

get_productos_pkte

CREATE PROCEDURE `get_productos_pkte`(
	IN p_tipodoc varchar(3),
    IN p_numdoc decimal(12)
)
BEGIN
Select F.ordinal, P.nombre, F.cantidad 
from mov_contable_detalle F 
join productos P on F.codigo_producto = P.codigo_producto
where F.tipo_documento = p_tipodoc
  and F.numero_documento = p_numdoc;
END

get_hr_apertura

CREATE FUNCTION `get_hr_apertura`(
    p_codigo_base DECIMAL(12,0),
    p_fecha_pedido DATETIME
) RETURNS datetime
    DETERMINISTIC
BEGIN
    DECLARE v_hr_apertura DATETIME;
    DECLARE v_dia INT;

    
    SET v_dia = DAYOFWEEK(p_fecha_pedido);
    
    
    SELECT bh.hr_apertura
    INTO v_hr_apertura
    FROM base_horarios bh
    WHERE bh.codigo_base = p_codigo_base
      AND bh.dia = v_dia
      AND time(bh.hr_apertura) >= time(p_fecha_pedido)
    ORDER BY bh.hr_apertura
    LIMIT 1;

    RETURN time(v_hr_apertura);
END
get_turno

CREATE FUNCTION `get_turno`(
    p_codigo_base DECIMAL(12),
    p_p_fecha DATETIME
) RETURNS time
    DETERMINISTIC
BEGIN
    DECLARE v_turno TIME;

    SELECT TIME(get_hr_apertura(p_codigo_base, p_p_fecha))
    INTO v_turno;

    RETURN v_turno;
END

get_usecase_link

CREATE DEFINER=`root`@`%` PROCEDURE `get_usecase_link`(
	IN p_codigo_usecase varchar(36)
)
BEGIN
	select codigo_usecase, caption, linktolaunch, icono
	from usecases
	where codigo_usecase = p_codigo_usecase;
END

erp.yml

connections:
  - name: "erpdb"
    dsn: "mysql://erpuser:Pepe1234++@tcp(127.0.0.1:3306)/erpdb"

ports:
  launcher: 3000
  modules:
    M1: 4000
    M2: 4001
    M3: 4002
    M4: 4003
  services:
    consola_paquetes: 4004
    google_routes: 3008
  usecases:
    CU1-001: 3001
    CU1-002: 3002
    CU1-003: 3003
    CU1-004: 3004
    CU1-005: 3005
    CU1-006: 3006
    CU1-007: 3007
    CU1-008: 3008
    CU2-001: 3009
    CU2-002: 3010
    CU2-003: 3011
    CU2-004: 3012
    CU3-001: 3013
    CU3-002: 3014
    CU3-003: 3015
    CU4-001: 3017
    CU4-002: 3018
    CU4-003: 3019
    CU4-004: 3020
    CU6-001: 3021

google_maps:
  api_key: "AIzaSyCGNcPSiLlcPlBq_34WzC52qApe3dgFkNw"
  default_center:
    lat: -12.0464
    lng: -77.0428
  default_zoom: 12



Anexo II. Style

/* Variables de color personalizadas */
:root {
    --kanban-bg: #f4f5f7;
    --column-bg: #ebedf0;
    --card-border: #0d6efd;
}

body {
    background-color: var(--kanban-bg);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden; /* Evita el scroll global para usar el del tablero */
}

/* Contenedor Principal Kanban */
.kanban-wrapper {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.navbar {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1000;
}

.kanban-board {
    display: flex;
    flex: 1;
    overflow-x: auto; /* Scroll horizontal para las columnas */
    padding: 20px;
    gap: 1.25rem;
    align-items: flex-start;
}

/* Estilos de las Columnas */
.kanban-column {
    min-width: 320px;
    max-width: 320px;
    background-color: var(--column-bg);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    max-height: 100%; /* Para que el scroll interno funcione */
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.column-header {
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.column-header h6 {
    margin: 0;
    font-weight: 700;
    color: #444;
    letter-spacing: 0.5px;
}

.column-body {
    padding: 0.75rem;
    overflow-y: auto; /* Scroll vertical para las cards */
    flex-grow: 1;
}

/* Estilo de las Cards de Paquetes */
.package-card {
    background: white;
    border-radius: 8px;
    border: none;
    border-left: 5px solid var(--card-border);
    margin-bottom: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.package-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.12) !important;
}

.package-card .card-body {
    padding: 1rem;
}

.card-id {
    font-size: 0.75rem;
    font-weight: bold;
    color: #6c757d;
}

/* Scrollbar personalizado para una apariencia moderna */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-track {
    background: #f1f1f1;
}
::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
}
::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* Responsive para dispositivos móviles */
@media (max-width: 768px) {
    .kanban-board {
        padding: 10px;
    }
    .kanban-column {
        min-width: 85vw;
    }
}
